<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Android开发">
<meta property="og:type" content="website">
<meta property="og:title" content="andy">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="andy">
<meta property="og:description" content="Android开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="andy">
<meta name="twitter:description" content="Android开发">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> andy </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">andy</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/24/android/Property/Property代码解读/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/24/android/Property/Property代码解读/" itemprop="url">
                  Property代码解读
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-24T01:38:00+08:00">
                2016-11-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/property/" itemprop="url" rel="index">
                    <span itemprop="name">property</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#prop_area的数据结构<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> prop_area &#123;</div><div class="line">    <span class="keyword">uint32_t</span> bytes_used;</div><div class="line">    <span class="keyword">atomic_uint_least32_t</span> serial;</div><div class="line">    <span class="keyword">uint32_t</span> magic;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line">    <span class="keyword">uint32_t</span> reserved[<span class="number">28</span>];</div><div class="line">    <span class="keyword">char</span> data[<span class="number">0</span>];</div><div class="line"></div><div class="line">    prop_area(<span class="keyword">const</span> <span class="keyword">uint32_t</span> magic, <span class="keyword">const</span> <span class="keyword">uint32_t</span> version) :</div><div class="line">        magic(magic), version(version) &#123;</div><div class="line">        atomic_init(&amp;serial, <span class="number">0</span>);</div><div class="line">        <span class="built_in">memset</span>(reserved, <span class="number">0</span>, <span class="keyword">sizeof</span>(reserved));</div><div class="line">        <span class="comment">// Allocate enough space for the root node.</span></div><div class="line">        bytes_used = <span class="keyword">sizeof</span>(prop_bt);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Properties are stored in a hybrid trie/binary tree structure.</div><div class="line"> * Each property's name is delimited at '.' characters, and the tokens are put</div><div class="line"> * into a trie structure.  Siblings at each level of the trie are stored in a</div><div class="line"> * binary tree.  For instance, "ro.secure"="1" could be stored as follows:</div><div class="line"> *</div><div class="line"> * +-----+   children    +----+   children    +--------+</div><div class="line"> * |     |--------------&gt;| ro |--------------&gt;| secure |</div><div class="line"> * +-----+               +----+               +--------+</div><div class="line"> *                       /    \                /   |</div><div class="line"> *                 left /      \ right   left /    |  prop   +===========+</div><div class="line"> *                     v        v            v     +--------&gt;| ro.secure |</div><div class="line"> *                  +-----+   +-----+     +-----+            +-----------+</div><div class="line"> *                  | net |   | sys |     | com |            |     1     |</div><div class="line"> *                  +-----+   +-----+     +-----+            +===========+</div><div class="line"> */</div><div class="line"> <span class="comment">//树节点的数据结构</span></div><div class="line"><span class="keyword">struct</span> prop_bt &#123;</div><div class="line">    <span class="keyword">uint8_t</span> namelen;</div><div class="line">    <span class="keyword">uint8_t</span> reserved[<span class="number">3</span>];</div><div class="line"></div><div class="line">    <span class="comment">// The property trie is updated only by the init process (single threaded) which provides</span></div><div class="line">    <span class="comment">// property service. And it can be read by multiple threads at the same time.</span></div><div class="line">    <span class="comment">// As the property trie is not protected by locks, we use atomic_uint_least32_t types for the</span></div><div class="line">    <span class="comment">// left, right, children "pointers" in the trie node. To make sure readers who see the</span></div><div class="line">    <span class="comment">// change of "pointers" can also notice the change of prop_bt structure contents pointed by</span></div><div class="line">    <span class="comment">// the "pointers", we always use release-consume ordering pair when accessing these "pointers".</span></div><div class="line"></div><div class="line">    <span class="comment">// prop "points" to prop_info structure if there is a propery associated with the trie node.</span></div><div class="line">    <span class="comment">// Its situation is similar to the left, right, children "pointers". So we use</span></div><div class="line">    <span class="comment">// atomic_uint_least32_t and release-consume ordering to protect it as well.</span></div><div class="line"></div><div class="line">    <span class="comment">// We should also avoid rereading these fields redundantly, since not</span></div><div class="line">    <span class="comment">// all processor implementations ensure that multiple loads from the</span></div><div class="line">    <span class="comment">// same field are carried out in the right order.</span></div><div class="line">    <span class="keyword">atomic_uint_least32_t</span> prop;</div><div class="line"></div><div class="line">    <span class="keyword">atomic_uint_least32_t</span> left;</div><div class="line">    <span class="keyword">atomic_uint_least32_t</span> right;</div><div class="line"></div><div class="line">    <span class="keyword">atomic_uint_least32_t</span> children;</div><div class="line"></div><div class="line">    <span class="keyword">char</span> name[<span class="number">0</span>];</div><div class="line"></div><div class="line">    prop_bt(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">uint8_t</span> name_length) &#123;</div><div class="line">        <span class="keyword">this</span>-&gt;namelen = name_length;</div><div class="line">        <span class="built_in">memcpy</span>(<span class="keyword">this</span>-&gt;name, name, name_length);</div><div class="line">        <span class="keyword">this</span>-&gt;name[name_length] = <span class="string">'\0'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    DISALLOW_COPY_AND_ASSIGN(prop_bt);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//属性的数据结构</span></div><div class="line"><span class="keyword">struct</span> prop_info &#123;</div><div class="line">    <span class="keyword">atomic_uint_least32_t</span> serial;</div><div class="line">    <span class="keyword">char</span> value[PROP_VALUE_MAX];</div><div class="line">    <span class="keyword">char</span> name[<span class="number">0</span>];</div><div class="line"></div><div class="line">    prop_info(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">uint8_t</span> namelen, <span class="keyword">const</span> <span class="keyword">char</span> *value,</div><div class="line">              <span class="keyword">const</span> <span class="keyword">uint8_t</span> valuelen) &#123;</div><div class="line">        <span class="built_in">memcpy</span>(<span class="keyword">this</span>-&gt;name, name, namelen);</div><div class="line">        <span class="keyword">this</span>-&gt;name[namelen] = <span class="string">'\0'</span>;</div><div class="line">        atomic_init(&amp;<span class="keyword">this</span>-&gt;serial, valuelen &lt;&lt; <span class="number">24</span>);</div><div class="line">        <span class="built_in">memcpy</span>(<span class="keyword">this</span>-&gt;value, value, valuelen);</div><div class="line">        <span class="keyword">this</span>-&gt;value[valuelen] = <span class="string">'\0'</span>;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    DISALLOW_COPY_AND_ASSIGN(prop_info);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>###查找一个属性<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> prop_info *__system_property_find(<span class="keyword">const</span> <span class="keyword">char</span> *name)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (__predict_false(compat_mode)) &#123;</div><div class="line">        <span class="keyword">return</span> __system_property_find_compat(name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> find_property(root_node(), name, <span class="built_in">strlen</span>(name), <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//获取跟节点</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> prop_bt *<span class="title">root_node</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;prop_bt*&gt;(to_prop_obj(<span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定位带某个节点</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">to_prop_obj</span><span class="params">(<span class="keyword">uint_least32_t</span> off)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (off &gt; pa_data_size)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (!__system_property_area__)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (__system_property_area__-&gt;data + off);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> prop_info *<span class="title">find_property</span><span class="params">(prop_bt *<span class="keyword">const</span> trie, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></div><div class="line">        <span class="keyword">uint8_t</span> namelen, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">uint8_t</span> valuelen,</div><div class="line">        <span class="keyword">bool</span> alloc_if_needed)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!trie) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *remaining_name = name;</div><div class="line">    prop_bt* current = trie;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *sep = <span class="built_in">strchr</span>(remaining_name, <span class="string">'.'</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> want_subtree = (sep != <span class="literal">NULL</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">uint8_t</span> substr_size = (want_subtree) ?</div><div class="line">            sep - remaining_name : <span class="built_in">strlen</span>(remaining_name);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!substr_size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        prop_bt* root = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">uint_least32_t</span> children_offset = atomic_load_explicit(&amp;current-&gt;children, memory_order_relaxed);</div><div class="line">        <span class="keyword">if</span> (children_offset != <span class="number">0</span>) &#123;</div><div class="line">            root = to_prop_bt(&amp;current-&gt;children);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (alloc_if_needed) &#123;</div><div class="line">            <span class="keyword">uint_least32_t</span> new_offset;</div><div class="line">            root = new_prop_bt(remaining_name, substr_size, &amp;new_offset);</div><div class="line">            <span class="keyword">if</span> (root) &#123;</div><div class="line">                atomic_store_explicit(&amp;current-&gt;children, new_offset, memory_order_release);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!root) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        current = find_prop_bt(root, remaining_name, substr_size, alloc_if_needed);</div><div class="line">        <span class="keyword">if</span> (!current) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!want_subtree)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        remaining_name = sep + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">uint_least32_t</span> prop_offset = atomic_load_explicit(&amp;current-&gt;prop, memory_order_relaxed);</div><div class="line">    <span class="keyword">if</span> (prop_offset != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> to_prop_info(&amp;current-&gt;prop);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (alloc_if_needed) &#123;</div><div class="line">        <span class="keyword">uint_least32_t</span> new_offset;</div><div class="line">        prop_info* new_info = new_prop_info(name, namelen, value, valuelen, &amp;new_offset);</div><div class="line">        <span class="keyword">if</span> (new_info) &#123;</div><div class="line">            atomic_store_explicit(&amp;current-&gt;prop, new_offset, memory_order_release);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> new_info;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#property_init</p>
<p>property_init的职责就是初始化客户端进程的属性存储区域，代码分析：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">property_init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//第一次调用property_area_initialized为false</span></div><div class="line">    <span class="keyword">if</span> (property_area_initialized) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    property_area_initialized = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (__system_property_area_init()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/*</span></div><div class="line">    pa_workspace是一个全局变量，其数据结构为：</div><div class="line">    static workspace pa_workspace;</div><div class="line">    struct workspace &#123;</div><div class="line">        size_t size;</div><div class="line">        int fd;</div><div class="line">    &#125;;</div><div class="line">    #define PROP_FILENAME "/dev/__properties__"</div><div class="line">    */</div><div class="line">    pa_workspace.size = <span class="number">0</span>;</div><div class="line">    pa_workspace.fd = open(PROP_FILENAME, O_RDONLY | O_NOFOLLOW | O_CLOEXEC);</div><div class="line">    <span class="keyword">if</span> (pa_workspace.fd == <span class="number">-1</span>) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to open %s: %s\n"</span>, PROP_FILENAME, strerror(errno));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">int</span> __system_property_area_init()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> map_prop_area_rw();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">map_prop_area_rw</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/* dev is a tmpfs that we can use to carve a shared workspace</span></div><div class="line">     * out of, so let's do that...</div><div class="line">     * property_filename定义：</div><div class="line">     * static char property_filename[PATH_MAX] = PROP_FILENAME;</div><div class="line">     * #define PROP_FILENAME "/dev/__properties__"</div><div class="line">     */</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> fd = open(property_filename,</div><div class="line">                        O_RDWR | O_CREAT | O_NOFOLLOW | O_CLOEXEC | O_EXCL, <span class="number">0444</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (errno == EACCES) &#123;</div><div class="line">            <span class="comment">/* for consistency with the case where the process has already</span></div><div class="line">             * mapped the page in and segfaults when trying to write to it</div><div class="line">             */</div><div class="line">            <span class="built_in">abort</span>();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//将/dev/__properties__的大小设置为PA_SIZE,便于mmap</span></div><div class="line">    <span class="comment">//#define PA_SIZE         (128 * 1024)</span></div><div class="line">    <span class="keyword">if</span> (ftruncate(fd, PA_SIZE) &lt; <span class="number">0</span>) &#123;</div><div class="line">        close(fd);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pa_size = PA_SIZE;</div><div class="line">    pa_data_size = pa_size - <span class="keyword">sizeof</span>(prop_area);</div><div class="line">    compat_mode = <span class="literal">false</span>;</div><div class="line">    <span class="comment">//创建一块共享内存</span></div><div class="line">    <span class="keyword">void</span> *<span class="keyword">const</span> memory_area = mmap(<span class="literal">NULL</span>, pa_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (memory_area == MAP_FAILED) &#123;</div><div class="line">        close(fd);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//创建一个prop_area的对象，对象的处于上面mmap出来的共享内存当中。</span></div><div class="line">    prop_area *pa = <span class="keyword">new</span>(memory_area) prop_area(PROP_AREA_MAGIC, PROP_AREA_VERSION);</div><div class="line"></div><div class="line">    <span class="comment">/* plug into the lib property services */</span></div><div class="line">    __system_property_area__ = pa;</div><div class="line"></div><div class="line">    close(fd);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>property_set<br>设置一个属性值，即往初始化好的属性区域写数据。代码分析：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">//这只是个接口，真正的实现在一个static方法property_set_impl中，接口和实现分开</div><div class="line">int property_set(const char* name, const char* value) &#123;</div><div class="line">    int rc = property_set_impl(name, value);</div><div class="line">    if (rc == -1) &#123;</div><div class="line">        ERROR(&quot;property_set(\&quot;%s\&quot;, \&quot;%s\&quot;) failed\n&quot;, name, value);</div><div class="line">    &#125;</div><div class="line">    return rc;</div><div class="line">&#125;</div><div class="line">static int property_set_impl(const char* name, const char* value) &#123;</div><div class="line">    size_t namelen = strlen(name);</div><div class="line">    size_t valuelen = strlen(value);</div><div class="line"></div><div class="line">    //属性名字的合法性进行判断，如长度，是否有特殊字符等</div><div class="line">    if (!is_legal_property_name(name, namelen)) return -1;</div><div class="line">    if (valuelen &gt;= PROP_VALUE_MAX) return -1;</div><div class="line"></div><div class="line">    //判断属性是否和selinux相关，并采取相关操作，详见selinux章节</div><div class="line">    if (strcmp(&quot;selinux.reload_policy&quot;, name) == 0 &amp;&amp; strcmp(&quot;1&quot;, value) == 0) &#123;</div><div class="line">        if (selinux_reload_policy() != 0) &#123;</div><div class="line">            ERROR(&quot;Failed to reload policy\n&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125; else if (strcmp(&quot;selinux.restorecon_recursive&quot;, name) == 0 &amp;&amp; valuelen &gt; 0) &#123;</div><div class="line">        if (restorecon_recursive(value) != 0) &#123;</div><div class="line">            ERROR(&quot;Failed to restorecon_recursive %s\n&quot;, value);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    prop_info* pi = (prop_info*) __system_property_find(name);</div><div class="line"></div><div class="line">    if(pi != 0) &#123;</div><div class="line">        /* ro.* properties may NEVER be modified once set */</div><div class="line">        if(!strncmp(name, &quot;ro.&quot;, 3)) return -1;</div><div class="line"></div><div class="line">        __system_property_update(pi, value, valuelen);</div><div class="line">    &#125; else &#123;</div><div class="line">        int rc = __system_property_add(name, namelen, value, valuelen);</div><div class="line">        if (rc &lt; 0) &#123;</div><div class="line">            return rc;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    /* If name starts with &quot;net.&quot; treat as a DNS property. */</div><div class="line">    if (strncmp(&quot;net.&quot;, name, strlen(&quot;net.&quot;)) == 0)  &#123;</div><div class="line">        if (strcmp(&quot;net.change&quot;, name) == 0) &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">       /*</div><div class="line">        * The &apos;net.change&apos; property is a special property used track when any</div><div class="line">        * &apos;net.*&apos; property name is updated. It is _ONLY_ updated here. Its value</div><div class="line">        * contains the last updated &apos;net.*&apos; property.</div><div class="line">        */</div><div class="line">        property_set(&quot;net.change&quot;, name);</div><div class="line">    &#125; else if (persistent_properties_loaded &amp;&amp;</div><div class="line">            strncmp(&quot;persist.&quot;, name, strlen(&quot;persist.&quot;)) == 0) &#123;</div><div class="line">        /*</div><div class="line">         * Don&apos;t write properties to disk until after we have read all default properties</div><div class="line">         * to prevent them from being overwritten by default values.</div><div class="line">         */</div><div class="line">        write_persistent_property(name, value);</div><div class="line">    &#125;</div><div class="line">    property_changed(name, value);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/tool/git/git-flow简介/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/23/tool/git/git-flow简介/" itemprop="url">
                  atomic类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-23T23:03:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/" itemprop="url" rel="index">
                    <span itemprop="name">tool</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#Git flow 开发流程</p>
<ul>
<li>branching model</li>
</ul>
<p>model分成兩個主要分支，三種支援性分支</p>
<pre><code>主要分支
    master: 永遠處在 production-ready 狀態
    develop: 最新的下次發佈開發狀態

支援性分支
    Feature branches: 開發新功能都從 develop 分支出來，完成後 merge 回 develop
    Release branches: 準備要 release 的版本，只修 bugs。從 develop 分支出來，完成後 merge 回 master 和 develop
    Hotfix branches: 等不及 release 版本就必須馬上修 master 趕上線的情況。會從 master 分支出來，完成後 merge 回 master 和 develop
</code></pre><hr>
<ul>
<li><p>create branching model</p>
<p>git flow init</p>
<pre><code>Initialized empty Git repository in /Users/fannheyward/flowTest/.git/
No branches exist yet. Base branches must be created now.
Branch name for production releases: [master]
Branch name for &quot;next release&quot; development: [develop]

How to name your supporting branch prefixes?
Feature branches? [feature/]
Release branches? [release/]
Hotfix branches? [hotfix/]
Support branches? [support/]
Version tag prefix? []
</code></pre></li>
</ul>
<hr>
<ul>
<li><p>新功能开发, 代号 f1</p>
<p>1.git flow feature start f1</p>
<pre><code>Switched to a new branch &apos;feature/f1&apos;

Summary of actions:
- A new branch &apos;feature/f1&apos; was created, based on &apos;develop&apos;
- You are now on branch &apos;feature/f1&apos;

Now, start committing on your feature. When done, use:

    git flow feature finish f1

git-flow 从 develop 分支创建了一个新的分支 feature/f1，并自动切换到这个分支下面。然后就可以进行 f1 功能开发，中间可以多次的 commit 操作。
</code></pre><p>2.git flow feature finish f1</p>
<pre><code>Switched to branch &apos;develop&apos;
Already up-to-date.
Deleted branch feature/f1 (was 7bb5749).

Summary of actions:
- The feature branch &apos;feature/f1&apos; was merged into &apos;develop&apos;
- Feature branch &apos;feature/f1&apos; has been removed
- You are now on branch &apos;develop&apos;

feature/f1 分支的代码会被合并到 develop 里面，然后删除该分支，切换回 develop. 到此，新功能开发这个场景完毕。在 f1 功能开发中，如果 f1 未完成，同时功能 f2 要开始进行，也是可以的。
</code></pre></li>
</ul>
<hr>
<ul>
<li><p>发布上线，代号 0.1</p>
<p>1.git flow release start 0.1</p>
<pre><code>Switched to a new branch &apos;release/0.1&apos;

Summary of actions:
- A new branch &apos;release/0.1&apos; was created, based on &apos;develop&apos;
- You are now on branch &apos;release/0.1&apos;

Follow-up actions:
- Bump the version number now!
- Start committing last-minute fixes in preparing your release
- When done, run:

git flow release finish &apos;0.1&apos;

git-flow 从 develop 分支创建一个新的分支 release/0.1，并切换到该分支下，接下来要做的就是修改版本号等发布操作。
</code></pre><p>2.git flow release finish 0.1</p>
<pre><code>Switched to branch &apos;master&apos;
Merge made by the &apos;recursive&apos; strategy.
f1      |    1 +
version |    1 +
2 files changed, 2 insertions(+)
create mode 100644 f1
create mode 100644 version
Switched to branch &apos;develop&apos;
Merge made by the &apos;recursive&apos; strategy.
version |    1 +
1 file changed, 1 insertion(+)
create mode 100644 version
Deleted branch release/0.1 (was d77df80).

Summary of actions:
- Latest objects have been fetched from &apos;origin&apos;
- Release branch has been merged into &apos;master&apos;
- The release was tagged &apos;0.1&apos;
- Release branch has been back-merged into &apos;develop&apos;
- Release branch &apos;release/0.1&apos; has been deleted

git-flow 会依次切换到 master develop 下合并 release/0.1 里的修改，然后用 git tag 的给当次发布打上 tag 0.1，可以通过 git tag 查看所有 tag：
</code></pre></li>
</ul>
<hr>
<ul>
<li><p>紧急 bug 修正，代号 bug1</p>
<p>1.git flow hotfix start bug1</p>
<pre><code>Switched to a new branch &apos;hotfix/bug1&apos;

Summary of actions:
- A new branch &apos;hotfix/bug1&apos; was created, based on &apos;master&apos;
- You are now on branch &apos;hotfix/bug1&apos;

Follow-up actions:
- Bump the version number now!
- Start committing your hot fixes
- When done, run:

    git flow hotfix finish &apos;bug1&apos;

git-flow 从 master 分支创建一个新的分支 hotfix/bug1，并切换到该分支下。接下来要做的就是修复 bug.
</code></pre><p>2.git flow hotfix finish ‘bug1’</p>
<pre><code>Switched to branch &apos;master&apos;
Merge made by the &apos;recursive&apos; strategy.
f1 |    2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Switched to branch &apos;develop&apos;
Merge made by the &apos;recursive&apos; strategy.
f1 |    2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
Deleted branch hotfix/bug1 (was aa3ca2e).

Summary of actions:
- Latest objects have been fetched from &apos;origin&apos;
- Hotfix branch has been merged into &apos;master&apos;
- The hotfix was tagged &apos;bug1&apos;
- Hotfix branch has been back-merged into &apos;develop&apos;
- Hotfix branch &apos;hotfix/bug1&apos; has been deleted

git-flow 会依次切换到 master develop 分支下合并 hotfix/bug1，然后删掉 hotfix/bug1。到此，hotfix 完成。
</code></pre></li>
</ul>
<hr>
<ul>
<li><p>remote branch</p>
<p>1.push 一個 feature branch 到遠端</p>
<pre><code>git flow feature publish some_awesome_feature
或 git push origin feature/some_awesome_feature
</code></pre><p>2.追蹤一個遠端的 branch</p>
<pre><code>git flow feature track some_awesome_feature
或 git checkout -b feature/some_awesome_feature -t origin/feature/some_awesome_feature
</code></pre><p>3.刪除遠端的 branch</p>
<pre><code>git push origin :feature/some_awesome_feature
</code></pre></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/android/常用类/atomic类/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/23/android/常用类/atomic类/" itemprop="url">
                  atomic类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-23T23:03:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/api/" itemprop="url" rel="index">
                    <span itemprop="name">api</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#atomic是什么</p>
<p>#atomic的一个例子<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">atomic_uint_least32_t</span> <span class="function">serial</span></div><div class="line"><span class="title">atomic_init</span><span class="params">(&amp;serial, <span class="number">0</span>)</span>;</div></pre></td></tr></table></figure></p>
<p>#atomic代码解读</p>
<ul>
<li>atomic变量的数据结构</li>
<li>atomic的相关操作</li>
</ul>
<p>```</p>
<p>#define _Atomic(T)              struct { T volatile __val; }<br>typedef _Atomic(bool)            atomic_bool;<br>typedef _Atomic(char)            atomic_char;<br>typedef _Atomic(signed char)        atomic_schar;<br>typedef _Atomic(unsigned char)        atomic_uchar;<br>typedef _Atomic(short)            atomic_short;<br>typedef _Atomic(unsigned short)        atomic_ushort;<br>typedef _Atomic(int)            atomic_int;<br>typedef _Atomic(unsigned int)        atomic_uint;<br>typedef _Atomic(long)            atomic_long;<br>typedef _Atomic(unsigned long)        atomic_ulong;<br>typedef _Atomic(long long)        atomic_llong;<br>typedef _Atomic(unsigned long long)    atomic_ullong;</p>
<p>#if <strong>STDC_VERSION</strong> &gt;= 201112L || __cplusplus &gt;= 201103L<br>  typedef _Atomic(char16_t)        atomic_char16_t;<br>  typedef _Atomic(char32_t)        atomic_char32_t;</p>
<p>#endif<br>typedef _Atomic(wchar_t)        atomic_wchar_t;<br>typedef _Atomic(int_least8_t)        atomic_int_least8_t;<br>typedef _Atomic(uint_least8_t)    atomic_uint_least8_t;<br>typedef _Atomic(int_least16_t)    atomic_int_least16_t;<br>typedef _Atomic(uint_least16_t)    atomic_uint_least16_t;<br>typedef _Atomic(int_least32_t)    atomic_int_least32_t;<br>typedef _Atomic(uint_least32_t)    atomic_uint_least32_t;<br>typedef _Atomic(int_least64_t)    atomic_int_least64_t;<br>typedef _Atomic(uint_least64_t)    atomic_uint_least64_t;<br>typedef _Atomic(int_fast8_t)        atomic_int_fast8_t;<br>typedef _Atomic(uint_fast8_t)        atomic_uint_fast8_t;<br>typedef _Atomic(int_fast16_t)        atomic_int_fast16_t;<br>typedef _Atomic(uint_fast16_t)    atomic_uint_fast16_t;<br>typedef _Atomic(int_fast32_t)        atomic_int_fast32_t;<br>typedef _Atomic(uint_fast32_t)    atomic_uint_fast32_t;<br>typedef _Atomic(int_fast64_t)        atomic_int_fast64_t;<br>typedef _Atomic(uint_fast64_t)    atomic_uint_fast64_t;<br>typedef _Atomic(intptr_t)        atomic_intptr_t;<br>typedef _Atomic(uintptr_t)        atomic_uintptr_t;<br>typedef _Atomic(size_t)        atomic_size_t;<br>typedef _Atomic(ptrdiff_t)        atomic_ptrdiff_t;<br>typedef _Atomic(intmax_t)        atomic_intmax_t;<br>typedef _Atomic(uintmax_t)        atomic_uintmax_t;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/android/Selinux/Seliux简介/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/23/android/Selinux/Seliux简介/" itemprop="url">
                  Seliux简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-23T16:43:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/android/Property/Property概述/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/23/android/Property/Property概述/" itemprop="url">
                  Property概述
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-23T15:57:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/property/" itemprop="url" rel="index">
                    <span itemprop="name">property</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#概述</p>
<p>属性（property）系统对Android来说是一个重要的功能。他作为一个系统服务管理着系统的配置和状态，所有的这些系统配置和状态都是属性 （property）。属性（property）是一对键/值（key/value）组合，键和值都是字符串类型。<br>总体感觉属性系统非常像Windows的注册表的功能。Android中非常多的应用程序和库直接或者间接的依赖于属性系统，并由此决定其运行期的行为。例如：adbd进程通过属性来决定是否当 前运行在模拟器中。再比如：java.io.File.pathSeparator方法返回存储在属性服务中的值。<br><br><br><br></p>
<p>#属性系统怎样工作<br>属性系统宏观的结构图如下所示：<br><img src="../../../images/00-57-09.jpg" alt=""><br><img src="/images/00-57-09.jpg" alt=""></p>
<p>从图中我们可以看出Android属性系统由有三个进程，一组属性文件和一块共享内存组成。这块共享内存保存着系统中所有的属性记录，只有 Property service能写这块共享内存，并且Property service负责将属性文件中的属性记录加载到共享内存中。</p>
<p>属性读取进程（property consumer）把这块共享内存映射到自己的进程空间，然后直接读取它。属性设置进程（property setter）也加载这块共享到他的进程空间，但是他不能直接写这块共享内存。当他需要增加或者修改属性的时候，通过Unix Socket发生属性给Property service，Property service将代表设置进程写入共享内存和属性文件。</p>
<p>Property service运行于init进程中。init进程首先创建一块共享内存，并把他的句柄fd存放在这块内存中，init进程通过mmap带 MAP_SHARE标志的系统调用，把这块内存映射到他的虚拟空间中，最终这块内存所有的更新将会被所有映射这块共享内存的进程看到。共享内存句柄fd和 共享内存大小存储在系统环境变量“ANDROID_PROPERTY_WORKSPACE”中，所有的进程包括属性设置进程和属性读取进程都将通过这个系 统环境变量获得共享内存的句柄fd和大小，然后把这块内存映射到他们自己的虚拟空间。共享内存布局如下：</p>
<p><img src="../../../images/01-06-04.jpg" alt=""><br><img src="/images/01-06-04.jpg" alt=""></p>
<p>然后，init进程将会从以下文件中加载属性：<br>&gt;<br>1   /default.prop<br>2   /system/build.prop<br>3   /system/default.prop<br>4   /data/local.prop</p>
<p>下一步是启动Property service。这步中，将会创建一个Unix Socket服务器，这个Socket有一个闻名的名称“/dev/socket/property_service”。最后init进入死循环，等待socket的连接请求。</p>
<p>在读取进程中，当它初始化libc库的时候，将会获得属性系统共享内存的句柄和大小（bionic/libc/bionic /libc_init_common.c <strong>libc_init_common函数）。并把这块共享内存映射到自己的进程虚拟空间中(bionic/libc/bionic /system_properties.c </strong>system_properties_init函数)。这样读取进程将会向访问普通内存一样访问属性系统的共享内存了。</p>
<p>当前，属性不能被删除。也就是说一旦属性被创建，将不可以被删除，但是它们可以被修改。<br><br><br><br></p>
<p>#怎样获得和设置属性</p>
<p>在Android中有三种方式来设置和获取属性：</p>
<ul>
<li><p>native code<br>当编写Native的程序时，可以使用property_get和property_set API来获得和设置属性。使用这两个API必须要包含头文件cutils/properties.h和链接libcutil库。<br><br></p>
</li>
<li><p>java code<br>Android在Java库中提供System.getProperty和System.setProperty方法，我们Java程序可以通过他们来设置和获得属性。<br>但是请注意！虽然从语法上面看Java的代码和Native代码非常相近，但是Java版本存储把属性存在其他地方，而不是我们上面提到的属性系统中。在 JVM中有一个hash表来维护Java的属性。所以Java属性和Android属性是不同的，不能用Java API（System.getProperty和System.setProperty）来设置系统属性。也不能通过Native的方法 （property_get和property_set）设置Java的属性。<br>更新：Andrew指出android.os.SystemProperties可以操作Android系统属性（虽然这个类倾向于内部使用）。这个类通过JNI调用Native的property_get和property_set方法来获得和设置属性。<br><br></p>
</li>
<li><p>shell script Shell脚本<br>getprop [keyname] Keyname为需要获取的键值名，如果没有参数则打印全部的键值信息。<br>setprop [keyname] [value] Keyname为需要获取的键值名，value为设置的值，这个值为字符串。<br>watchprops 监听系统属性的变化，如果期间系统的属性发生变化则把变化的值显示出来。<br><br><br><br></p>
</li>
</ul>
<p>#Android 系统的配置信息</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/android/Init/Init简介/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/23/android/Init/Init简介/" itemprop="url">
                  Init简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-23T14:59:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/init/" itemprop="url" rel="index">
                    <span itemprop="name">init</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#概述<br>Android系统是运作在linux kernal上的，因此它的启动过程也遵循linux的启动过程，当linux内核启动之后，运行的第一个进程是init，这个进程是一个守护进程，它的生命周期贯穿整个linux 内核运行的始终， linux中所有其他的进程的共同始祖均为init进程。<br>作为天字第一号进程，init进程被赋予了很多及其重要的职责：</p>
<blockquote>
<p>  建立各种用户空间的目录，并挂载相关的文件系统</p>
</blockquote>
<p>#解读代码<br>init的代码位于/system/core/init/init.cpp中，入口函数为main，<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"ueventd"</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> ueventd_main(argc, argv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"watchdogd"</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> watchdogd_main(argc, argv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Clear the umask.</span></div><div class="line">    umask(<span class="number">0</span>);</div><div class="line"></div><div class="line">    add_environment(<span class="string">"PATH"</span>, _PATH_DEFPATH);</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--second-stage"</span>) != <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></div><div class="line">    <span class="comment">// on / and then we'll let the rc file figure out the rest.</span></div><div class="line">    <span class="comment">//挂载一些linux的基本文件系统</span></div><div class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</div><div class="line">        mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</div><div class="line">        mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</div><div class="line">        mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</div><div class="line">        mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">        mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">        mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// We must have some place other than / to create the device nodes for</span></div><div class="line">    <span class="comment">// kmsg and null, otherwise we won't be able to remount / read-only</span></div><div class="line">    <span class="comment">// later on. Now that tmpfs is mounted on /dev, we can actually talk</span></div><div class="line">    <span class="comment">// to the outside world.</span></div><div class="line">    <span class="comment">//重定向标准输出输入错误到/dev/_null_</span></div><div class="line">    open_devnull_stdio();</div><div class="line"></div><div class="line">    <span class="comment">//打开/dev/kmesg, 并设置为init的日志输出设备</span></div><div class="line">    klog_init();</div><div class="line">    klog_set_level(KLOG_NOTICE_LEVEL);</div><div class="line"></div><div class="line">    NOTICE(<span class="string">"init%s started!\n"</span>, is_first_stage ? <span class="string">""</span> : <span class="string">" second stage"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!is_first_stage) &#123;</div><div class="line">        <span class="comment">// Indicate that booting is in progress to background fw loaders, etc.</span></div><div class="line">        close(open(<span class="string">"/dev/.booting"</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</div><div class="line">        <span class="comment">//初始化本进程的属性存储区域</span></div><div class="line">        property_init();</div><div class="line"></div><div class="line">        <span class="comment">// If arguments are passed both on the command line and in DT,</span></div><div class="line">        <span class="comment">// properties set in DT always have priority over the command-line ones.</span></div><div class="line">        <span class="comment">// TODO</span></div><div class="line">        process_kernel_dt();</div><div class="line">        process_kernel_cmdline();</div><div class="line"></div><div class="line">        <span class="comment">// Propogate the kernel variables to internal variables</span></div><div class="line">        <span class="comment">// used by init as well as the current required properties.</span></div><div class="line">        export_kernel_boot_props();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span></div><div class="line">    selinux_initialize(is_first_stage);</div><div class="line"></div><div class="line">    <span class="comment">// If we're in the kernel domain, re-exec init to transition to the init domain now</span></div><div class="line">    <span class="comment">// that the SELinux policy has been loaded.</span></div><div class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</div><div class="line">        <span class="keyword">if</span> (restorecon(<span class="string">"/init"</span>) == <span class="number">-1</span>) &#123;</div><div class="line">            ERROR(<span class="string">"restorecon failed: %s\n"</span>, strerror(errno));</div><div class="line">            security_failure();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">char</span>* path = argv[<span class="number">0</span>];</div><div class="line">        <span class="keyword">char</span>* args[] = &#123; path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"--second-stage"</span>), <span class="literal">nullptr</span> &#125;;</div><div class="line">        <span class="keyword">if</span> (execv(path, args) == <span class="number">-1</span>) &#123;</div><div class="line">            ERROR(<span class="string">"execv(\"%s\") failed: %s\n"</span>, path, strerror(errno));</div><div class="line">            security_failure();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// These directories were necessarily created before initial policy load</span></div><div class="line">    <span class="comment">// and therefore need their security context restored to the proper value.</span></div><div class="line">    <span class="comment">// This must happen before /dev is populated by ueventd.</span></div><div class="line">    INFO(<span class="string">"Running restorecon...\n"</span>);</div><div class="line">    restorecon(<span class="string">"/dev"</span>);</div><div class="line">    restorecon(<span class="string">"/dev/socket"</span>);</div><div class="line">    restorecon(<span class="string">"/dev/__properties__"</span>);</div><div class="line">    restorecon_recursive(<span class="string">"/sys"</span>);</div><div class="line"></div><div class="line">    epoll_fd = epoll_create1(EPOLL_CLOEXEC);</div><div class="line">    <span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</div><div class="line">        ERROR(<span class="string">"epoll_create1 failed: %s\n"</span>, strerror(errno));</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    signal_handler_init();</div><div class="line"></div><div class="line">    property_load_boot_defaults();</div><div class="line">    start_property_service();</div><div class="line"></div><div class="line">    init_parse_config_file(<span class="string">"/init.rc"</span>);</div><div class="line"></div><div class="line">    action_for_each_trigger(<span class="string">"early-init"</span>, action_add_queue_tail);</div><div class="line"></div><div class="line">    <span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></div><div class="line">    queue_builtin_action(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</div><div class="line">    <span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></div><div class="line">    queue_builtin_action(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</div><div class="line">    queue_builtin_action(keychord_init_action, <span class="string">"keychord_init"</span>);</div><div class="line">    queue_builtin_action(console_init_action, <span class="string">"console_init"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Trigger all the boot actions to get us started.</span></div><div class="line">    action_for_each_trigger(<span class="string">"init"</span>, action_add_queue_tail);</div><div class="line"></div><div class="line">    <span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></div><div class="line">    <span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></div><div class="line">    queue_builtin_action(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></div><div class="line">    <span class="keyword">char</span> bootmode[PROP_VALUE_MAX];</div><div class="line">    <span class="keyword">if</span> (property_get(<span class="string">"ro.bootmode"</span>, bootmode) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(bootmode, <span class="string">"charger"</span>) == <span class="number">0</span>) &#123;</div><div class="line">        action_for_each_trigger(<span class="string">"charger"</span>, action_add_queue_tail);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        action_for_each_trigger(<span class="string">"late-init"</span>, action_add_queue_tail);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Run all property triggers based on current state of the properties.</span></div><div class="line">    queue_builtin_action(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!waiting_for_exec) &#123;</div><div class="line">            execute_one_command();</div><div class="line">            restart_processes();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> timeout = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">if</span> (process_needs_restart) &#123;</div><div class="line">            timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</div><div class="line">            <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</div><div class="line">                timeout = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!action_queue_empty() || cur_action) &#123;</div><div class="line">            timeout = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        bootchart_sample(&amp;timeout);</div><div class="line"></div><div class="line">        epoll_event ev;</div><div class="line">        <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, timeout));</div><div class="line">        <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</div><div class="line">            ERROR(<span class="string">"epoll_wait failed: %s\n"</span>, strerror(errno));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</div><div class="line">            ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/22/android/Linker/Linker简介/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/22/android/Linker/Linker简介/" itemprop="url">
                  Linker简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-22T14:05:00+08:00">
                2016-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/linker/" itemprop="url" rel="index">
                    <span itemprop="name">linker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##linker初始化</p>
<p>###_start<br>linke的入口函数, 该函数调用了linker_init，并传入一个参数sp(堆栈指针)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ENTRY(_start)</div><div class="line">  mov x0, sp</div><div class="line">  bl __linker_init</div><div class="line"></div><div class="line">  /* linker init returns the _entry address in the main image */</div><div class="line">  br x0</div><div class="line">END(_start)</div></pre></td></tr></table></figure></p>
<p>###__linker_init<br>负责初始化 linker，完成 linker 的重定位工作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot; ElfW(Addr) __linker_init(void* raw_args) &#123;</div><div class="line">  KernelArgumentBlock args(raw_args);</div><div class="line"></div><div class="line">  //linker 镜像的开始地址</div><div class="line">  ElfW(Addr) linker_addr = args.getauxval(AT_BASE);</div><div class="line"></div><div class="line">  //linker的入口点，禁止shell中调用linker</div><div class="line">  ElfW(Addr) entry_point = args.getauxval(AT_ENTRY);</div><div class="line">  ElfW(Ehdr)* elf_hdr = reinterpret_cast&lt;ElfW(Ehdr)*&gt;(linker_addr);</div><div class="line">  ElfW(Phdr)* phdr = reinterpret_cast&lt;ElfW(Phdr)*&gt;(linker_addr + elf_hdr-&gt;e_phoff);</div><div class="line"></div><div class="line">  soinfo linker_so(nullptr, nullptr, 0, 0);</div><div class="line"></div><div class="line">  // If the linker is not acting as PT_INTERP entry_point is equal to</div><div class="line">  // _start. Which means that the linker is running as an executable and</div><div class="line">  // already linked by PT_INTERP.</div><div class="line">  //</div><div class="line">  // This happens when user tries to run &apos;adb shell /system/bin/linker&apos;</div><div class="line">  // see also https://code.google.com/p/android/issues/detail?id=63174</div><div class="line">  if (reinterpret_cast&lt;ElfW(Addr)&gt;(&amp;_start) == entry_point) &#123;</div><div class="line">    __libc_fatal(&quot;This is %s, the helper program for shared library executables.\n&quot;, args.argv[0]);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  linker_so.base = linker_addr;</div><div class="line">  linker_so.size = phdr_table_get_load_size(phdr, elf_hdr-&gt;e_phnum);</div><div class="line">  linker_so.load_bias = get_elf_exec_load_bias(elf_hdr);</div><div class="line">  linker_so.dynamic = nullptr;</div><div class="line">  linker_so.phdr = phdr;</div><div class="line">  linker_so.phnum = elf_hdr-&gt;e_phnum;</div><div class="line">  linker_so.set_linker_flag();</div><div class="line"></div><div class="line">  // This might not be obvious... The reasons why we pass g_empty_list</div><div class="line">  // in place of local_group here are (1) we do not really need it, because</div><div class="line">  // linker is built with DT_SYMBOLIC and therefore relocates its symbols against</div><div class="line">  // itself without having to look into local_group and (2) allocators</div><div class="line">  // are not yet initialized, and therefore we cannot use linked_list.push_*</div><div class="line">  // functions at this point.</div><div class="line">  //linker的重定向工作</div><div class="line">  if (!(linker_so.prelink_image() &amp;&amp; linker_so.link_image(g_empty_list, g_empty_list, nullptr))) &#123;</div><div class="line">    // It would be nice to print an error message, but if the linker</div><div class="line">    // can&apos;t link itself, there&apos;s no guarantee that we&apos;ll be able to</div><div class="line">    // call write() (because it involves a GOT reference). We may as</div><div class="line">    // well try though...</div><div class="line">    const char* msg = &quot;CANNOT LINK EXECUTABLE: &quot;;</div><div class="line">    write(2, msg, strlen(msg));</div><div class="line">    write(2, __linker_dl_err_buf, strlen(__linker_dl_err_buf));</div><div class="line">    write(2, &quot;\n&quot;, 1);</div><div class="line">    _exit(EXIT_FAILURE);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  __libc_init_tls(args);</div><div class="line"></div><div class="line">  // Initialize the linker&apos;s own global variables</div><div class="line">  linker_so.call_constructors();</div><div class="line"></div><div class="line">  // Initialize static variables. Note that in order to</div><div class="line">  // get correct libdl_info we need to call constructors</div><div class="line">  // before get_libdl_info().</div><div class="line">  solist = get_libdl_info();</div><div class="line">  sonext = get_libdl_info();</div><div class="line"></div><div class="line">  // We have successfully fixed our own relocations. It&apos;s safe to run</div><div class="line">  // the main part of the linker now.</div><div class="line">  args.abort_message_ptr = &amp;g_abort_message;</div><div class="line">  ElfW(Addr) start_address = __linker_init_post_relocation(args, linker_addr);</div><div class="line"></div><div class="line">  INFO(&quot;[ jumping to _start ]&quot;);</div><div class="line"></div><div class="line">  // Return the address that the calling assembly stub should jump to.</div><div class="line">  return start_address;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###__linker_init_post_relocation<br>初始化property, 连接debugd，预加载一下系统库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">static ElfW(Addr) __linker_init_post_relocation(KernelArgumentBlock&amp; args, ElfW(Addr) linker_base) &#123;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  __system_properties_init();</div><div class="line">  debuggerd_init();</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  const char* ldpath_env = nullptr;</div><div class="line">  const char* ldpreload_env = nullptr;</div><div class="line">  if (!getauxval(AT_SECURE)) &#123;</div><div class="line">    ldpath_env = getenv(&quot;LD_LIBRARY_PATH&quot;);</div><div class="line">    ldpreload_env = getenv(&quot;LD_PRELOAD&quot;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  soinfo* si = soinfo_alloc(args.argv[0], nullptr, 0, RTLD_GLOBAL);</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  parse_LD_LIBRARY_PATH(ldpath_env);</div><div class="line">  parse_LD_PRELOAD(ldpreload_env);</div><div class="line"></div><div class="line">  somain = si;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  for (const auto&amp; ld_preload_name : g_ld_preload_names) &#123;</div><div class="line">    needed_library_name_list.push_back(ld_preload_name.c_str());</div><div class="line">    ++needed_libraries_count;</div><div class="line">    ++ld_preloads_count;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  for_each_dt_needed(si, [&amp;](const char* name) &#123;</div><div class="line">    needed_library_name_list.push_back(name);</div><div class="line">    ++needed_libraries_count;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  const char* needed_library_names[needed_libraries_count];</div><div class="line"></div><div class="line">  memset(needed_library_names, 0, sizeof(needed_library_names));</div><div class="line">  needed_library_name_list.copy_to_array(needed_library_names, needed_libraries_count);</div><div class="line"></div><div class="line">  if (needed_libraries_count &gt; 0 &amp;&amp;</div><div class="line">      !find_libraries(si, needed_library_names, needed_libraries_count, nullptr,</div><div class="line">          &amp;g_ld_preloads, ld_preloads_count, RTLD_GLOBAL, nullptr)) &#123;</div><div class="line">    __libc_format_fd(2, &quot;CANNOT LINK EXECUTABLE: %s\n&quot;, linker_get_error_buffer());</div><div class="line">    exit(EXIT_FAILURE);</div><div class="line">  &#125; else if (needed_libraries_count == 0) &#123;</div><div class="line">    if (!si-&gt;link_image(g_empty_list, soinfo::soinfo_list_t::make_list(si), nullptr)) &#123;</div><div class="line">      __libc_format_fd(2, &quot;CANNOT LINK EXECUTABLE: %s\n&quot;, linker_get_error_buffer());</div><div class="line">      exit(EXIT_FAILURE);</div><div class="line">    &#125;</div><div class="line">    si-&gt;increment_ref_count();</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> ...</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    ProtectedDataGuard guard;</div><div class="line"></div><div class="line">    si-&gt;call_pre_init_constructors();</div><div class="line">    ...</div><div class="line">    si-&gt;call_constructors();</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  TRACE(&quot;[ Ready to execute &apos;%s&apos; @ %p ]&quot;, si-&gt;get_realpath(), reinterpret_cast&lt;void*&gt;(si-&gt;entry));</div><div class="line">  return si-&gt;entry;</div></pre></td></tr></table></figure></p>
<p>##动态库的加载过程<br>dlopen-&gt;dlopen_ext-&gt;do_dlopen<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">soinfo* do_dlopen(const char* name, int flags, const android_dlextinfo* extinfo) &#123;</div><div class="line">  if ((flags &amp; ~(RTLD_NOW|RTLD_LAZY|RTLD_LOCAL|RTLD_GLOBAL|RTLD_NODELETE|RTLD_NOLOAD)) != 0) &#123;</div><div class="line">    DL_ERR(&quot;invalid flags to dlopen: %x&quot;, flags);</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line">  if (extinfo != nullptr) &#123;</div><div class="line">    if ((extinfo-&gt;flags &amp; ~(ANDROID_DLEXT_VALID_FLAG_BITS)) != 0) &#123;</div><div class="line">      DL_ERR(&quot;invalid extended flags to android_dlopen_ext: 0x%&quot; PRIx64, extinfo-&gt;flags);</div><div class="line">      return nullptr;</div><div class="line">    &#125;</div><div class="line">    if ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) == 0 &amp;&amp;</div><div class="line">        (extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != 0) &#123;</div><div class="line">      DL_ERR(&quot;invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without &quot;</div><div class="line">          &quot;ANDROID_DLEXT_USE_LIBRARY_FD): 0x%&quot; PRIx64, extinfo-&gt;flags);</div><div class="line">      return nullptr;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ProtectedDataGuard guard;</div><div class="line">  soinfo* si = find_library(name, flags, extinfo);</div><div class="line">  if (si != nullptr) &#123;</div><div class="line">    si-&gt;call_constructors();</div><div class="line">  &#125;</div><div class="line">  return si;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>find_library-&gt;find_libraries<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">static bool find_libraries(soinfo* start_with, const char* const library_names[],</div><div class="line">      size_t library_names_count, soinfo* soinfos[], std::vector&lt;soinfo*&gt;* ld_preloads,</div><div class="line">      size_t ld_preloads_count, int rtld_flags, const android_dlextinfo* extinfo) &#123;</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">  // Step 1: load and pre-link all DT_NEEDED libraries in breadth first order.</div><div class="line">  for (LoadTask::unique_ptr task(load_tasks.pop_front());</div><div class="line">      task.get() != nullptr; task.reset(load_tasks.pop_front())) &#123;</div><div class="line">    soinfo* si = find_library_internal(load_tasks, task-&gt;get_name(), rtld_flags, extinfo);</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Step 2: link libraries.</div><div class="line"> ...</div><div class="line">  bool linked = local_group.visit([&amp;](soinfo* si) &#123;</div><div class="line">    if (!si-&gt;is_linked()) &#123;</div><div class="line">      if (!si-&gt;link_image(global_group, local_group, extinfo)) &#123;</div><div class="line">        return false;</div><div class="line">      &#125;</div><div class="line">      si-&gt;set_linked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return true;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>find_library_internal-&gt;load_library-&gt;load_library<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static soinfo* load_library(int fd, off64_t file_offset,</div><div class="line">                            LoadTaskList&amp; load_tasks,</div><div class="line">                            const char* name, int rtld_flags,</div><div class="line">                            const android_dlextinfo* extinfo) &#123;</div><div class="line"> ...</div><div class="line">  // Read the ELF header and load the segments.</div><div class="line">  ElfReader elf_reader(realpath.c_str(), fd, file_offset, file_stat.st_size);</div><div class="line">  if (!elf_reader.Load(extinfo)) &#123;</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  soinfo* si = soinfo_alloc(realpath.c_str(), &amp;file_stat, file_offset, rtld_flags);</div><div class="line">  if (si == nullptr) &#123;</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line">  si-&gt;base = elf_reader.load_start();</div><div class="line">  si-&gt;size = elf_reader.load_size();</div><div class="line">  si-&gt;load_bias = elf_reader.load_bias();</div><div class="line">  si-&gt;phnum = elf_reader.phdr_count();</div><div class="line">  si-&gt;phdr = elf_reader.loaded_phdr();</div><div class="line"></div><div class="line">  if (!si-&gt;prelink_image()) &#123;</div><div class="line">    soinfo_free(si);</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  for_each_dt_needed(si, [&amp;] (const char* name) &#123;</div><div class="line">    load_tasks.push_back(LoadTask::create(name, si));</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  return si;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/22/android/Linker/Elf简介/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="andy">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="andy">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="andy" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/22/android/Linker/Elf简介/" itemprop="url">
                  Elf简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-22T13:57:00+08:00">
                2016-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/linker/" itemprop="url" rel="index">
                    <span itemprop="name">linker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ELF(Executable and Linkable Format)即可执行连接文件格式，是Linux默认的目标文件格式，分析elf文件有助于理解一些重要的系统概念，例如程序的编译和链接，程序的加载和运行等。</p>
<p>##ELF文件类型<br>a)可重定位文件:用户和其他目标文件一起创建可执行文件或者共享目标文件,例如lib<em>.a文件。<br>b)可执行文件：用于生成进程映像，载入内存执行,例如编译好的可执行文件a.out。<br>c)共享目标文件：用于和其他共享目标文件或者可重定位文件一起生成elf目标文件或者和执行文件一起创建进程映像，例如lib</em>.so文件。</p>
<p>##ELF文件的组织<br>ELF文件参与程序的连接(建立一个程序)和程序的执行(运行一个程序)，编译器和链接器将其视为节头表(section header table)描述的一些节(section)的集合，而加载器则将其视为程序头表(program header table)描述的段(segment)的集合，通常一个段可以包含多个节。可重定位文件都包含一个节头表，可执行文件都包含一个程序头表。共享文件两者都包含有。为此，ELF文件格式同时提供了两种看待文件内容的方式，反映了不同行为的不同要求。</p>
<p>###文件头(Elf header)<br>Elf头在程序的开始部位，作为引路表描述整个ELF的文件结构，其信息大致分为四部分：一是系统相关信息，二是目标文件类型，三是加载相关信息，四是链接相关信息。<br>其中系统相关信息包括elf文件魔数(标识elf文件)，平台位数，数据编码方式，elf头部版本，硬件平台e_machine，目标文件版本 e_version，处理器特定标志e_ftags：这些信息的引入极大增强了elf文件的可移植性，使交叉编译成为可能。目标文件类型用e_type的值表示，可重定位文件为1，可执行文件为2，共享文件为3;加载相关信息有：程序进入点e_entry．程序头表偏移量e_phoff，elf头部长度 e_ehsize，程序头表中一个条目的长度e_phentsize，程序头表条目数目e_phnum;链接相关信息有：节头表偏移量e_shoff，节头表中一个条目的长度e_shentsize，节头表条目个数e_shnum ，节头表字符索引e shstmdx。可使用命令”readelf -h filename”来察看文件头的内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">typedef struct elf32_hdr&#123;</div><div class="line">unsigned char e_ident[EI_NIDENT];</div><div class="line">Elf32_Half e_type;//目标文件类型</div><div class="line">Elf32_Half e_machine;//硬件平台</div><div class="line">Elf32_Word e_version;//elf头部版本</div><div class="line">Elf32_Addr e_entry;//程序进入点</div><div class="line">Elf32_Off e_phoff;//程序头表偏移量</div><div class="line">Elf32_Off e_shoff;//节头表偏移量</div><div class="line">Elf32_Word e_flags;/处理器特定标志</div><div class="line">Elf32_Half e_ehsize;//elf头部长度</div><div class="line">Elf32_Half e_phentsize;//程序头表中一个条目的长度</div><div class="line">Elf32_Half e_phnum;//程序头表条目数目</div><div class="line">Elf32_Half e_shentsize;//节头表中一个条目的长度</div><div class="line">Elf32_Half e_shnum;//节头表条目个数</div><div class="line">Elf32_Half e_shstrmdx;//节头表字符索引</div><div class="line">&#125;Elf32_Ehdr;</div><div class="line"></div><div class="line">linker64的文件头：</div><div class="line">ELF Header:</div><div class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</div><div class="line">  Class:                             ELF64</div><div class="line">  Data:                              2&apos;s complement, little endian</div><div class="line">  Version:                           1 (current)</div><div class="line">  OS/ABI:                            UNIX - System V</div><div class="line">  ABI Version:                       0</div><div class="line">  Type:                              DYN (Shared object file)</div><div class="line">  Machine:                           AArch64</div><div class="line">  Version:                           0x1</div><div class="line">  Entry point address:               0x6cb4</div><div class="line">  Start of program headers:          64 (bytes into file)</div><div class="line">  Start of section headers:          924600 (bytes into file)</div><div class="line">  Flags:                             0x0</div><div class="line">  Size of this header:               64 (bytes)</div><div class="line">  Size of program headers:           56 (bytes)</div><div class="line">  Number of program headers:         8</div><div class="line">  Size of section headers:           64 (bytes)</div><div class="line">  Number of section headers:         24</div><div class="line">  Section header string table index: 21</div></pre></td></tr></table></figure></p>
<p>###程序头表(program header table)<br>程序头表告诉系统如何建立一个进程映像．它是从加载执行的角度来看待elf文件．从它的角度看．elf文件被分成许多段，elf文件中的代码、链接信息和注释都以段的形式存放。每个段都在程序头表中有一个表项描述，包含以下属性：段的类型，段的驻留位置相对于文件开始处的偏移，段在内存中的首字节地址，段的物理地址，段在文件映像中的字节数．段在内存映像中的字节数，段在内存和文件中的对齐标记。可用”readelf -l filename”察看程序头表中的内容。程序头表的结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">typedef struct elf32_phdr&#123;</div><div class="line">Elf32_Word p_type; //段的类型</div><div class="line">Elf32_Off p_offset; //段的位置相对于文件开始处的偏移</div><div class="line">Elf32_Addr p_vaddr; //段在内存中的首字节地址</div><div class="line">Elf32_Addr p_paddr;//段的物理地址</div><div class="line">Elf32_Word p_filesz;//段在文件映像中的字节数</div><div class="line">Elf32_Word p_memsz;//段在内存映像中的字节数</div><div class="line">Elf32_Word p_flags;//段的标记</div><div class="line">Elf32_Word p_align;，/段在内存中的对齐标记</div><div class="line">)Elf32_Phdr;</div><div class="line"></div><div class="line">Program Headers:</div><div class="line">  Type           Offset             VirtAddr           PhysAddr</div><div class="line">                 FileSiz            MemSiz              Flags  Align</div><div class="line">  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040</div><div class="line">                 0x00000000000001c0 0x00000000000001c0  R      8</div><div class="line">  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000</div><div class="line">                 0x00000000000a7a9c 0x00000000000a7a9c  R E    1000</div><div class="line">  LOAD           0x00000000000a8630 0x00000000000a9630 0x00000000000a9630</div><div class="line">                 0x00000000000036b0 0x0000000000009f94  RW     1000</div><div class="line">  DYNAMIC        0x00000000000aaa98 0x00000000000aba98 0x00000000000aba98</div><div class="line">                 0x0000000000000150 0x0000000000000150  RW     8</div><div class="line">  NOTE           0x0000000000000200 0x0000000000000200 0x0000000000000200</div><div class="line">                 0x0000000000000020 0x0000000000000020  R      4</div><div class="line">  GNU_EH_FRAME   0x00000000000a58d0 0x00000000000a58d0 0x00000000000a58d0</div><div class="line">                 0x00000000000021cc 0x00000000000021cc  R      4</div><div class="line">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</div><div class="line">                 0x0000000000000000 0x0000000000000000  RW     0</div><div class="line">  GNU_RELRO      0x00000000000a8630 0x00000000000a9630 0x00000000000a9630</div><div class="line">                 0x00000000000029d0 0x00000000000029d0  RW     10</div></pre></td></tr></table></figure></p>
<p>###节头表(section header table)<br>节头表描述程序节，为编译器和链接器服务。它把elf文件分成了许多节．每个节保存着用于不同目的的数据．这些数据可能被前面的程序头重复使用，完成一次任务所需的信息往往被分散到不同的节里。由于节中数据的用途不同，节被分成不同的类型，每种类型的节都有自己组织数据的方式。每一个节在节头表中都有一个表项描述该节的属性，节的属性包括小节名在字符表中的索引，类型，属性，运行时的虚拟地址，文件偏移，以字节为单位的大小，小节的对齐等信息，可使用”readelf -S filename”来察看节头表的内容。节头表的结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">typedef struct&#123;</div><div class="line">Elf32_Word sh_name;//小节名在字符表中的索引</div><div class="line">E1t32_Word sh_type;//小节的类型</div><div class="line">Elf32_Word sh_flags;//小节属性</div><div class="line">Elf32_Addr sh_addr; //小节在运行时的虚拟地址</div><div class="line">Elf32_Off sh_offset;//小节的文件偏移</div><div class="line">Elf32_Word sh_size;//小节的大小．以字节为单位</div><div class="line">Elf32_Word sh_link;//链接的另外一小节的索引</div><div class="line">Elf32 Word sh_info;//附加的小节信息</div><div class="line">Elf32 Word sh_addralign;//小节的对齐</div><div class="line">Elf32 Word sh_entsize; //一些sections保存着一张固定大小入口的表。就像符号表</div><div class="line">&#125;Elf32_Shdr;</div><div class="line"></div><div class="line">linker64的section：</div><div class="line">Section Headers:</div><div class="line">  [Nr] Name              Type             Address           Offset</div><div class="line">       Size              EntSize          Flags  Link  Info  Align</div><div class="line">  [ 0]                   NULL             0000000000000000  00000000</div><div class="line">       0000000000000000  0000000000000000           0     0     0</div><div class="line">  [ 1] .note.gnu.build-i NOTE             0000000000000200  00000200</div><div class="line">       0000000000000020  0000000000000000   A       0     0     4</div><div class="line">  [ 2] .dynsym           DYNSYM           0000000000000220  00000220</div><div class="line">       0000000000000090  0000000000000018   A       3     1     8</div><div class="line">  [ 3] .dynstr           STRTAB           00000000000002b0  000002b0</div><div class="line">       0000000000000033  0000000000000000   A       0     0     1</div><div class="line">  [ 4] .gnu.hash         GNU_HASH         00000000000002e8  000002e8</div><div class="line">       0000000000000038  0000000000000000   A       2     0     8</div><div class="line">  [ 5] .rela.dyn         RELA             0000000000000320  00000320</div><div class="line">       0000000000006258  0000000000000018   A       2     0     8</div><div class="line">  [ 6] .text             PROGBITS         0000000000006580  00006580</div><div class="line">       0000000000082124  0000000000000000  AX       0     0     64</div><div class="line">  [ 7] .rodata           PROGBITS         00000000000886b0  000886b0</div><div class="line">       0000000000009770  0000000000000000   A       0     0     16</div><div class="line">  [ 8] .gcc_except_table PROGBITS         0000000000091e20  00091e20</div><div class="line">       0000000000009a20  0000000000000000   A       0     0     4</div><div class="line">  [ 9] .eh_frame         PROGBITS         000000000009b840  0009b840</div><div class="line">       000000000000a090  0000000000000000   A       0     0     8</div><div class="line">  [10] .eh_frame_hdr     PROGBITS         00000000000a58d0  000a58d0</div><div class="line">       00000000000021cc  0000000000000000   A       0     0     4</div><div class="line">  [11] .data.rel.ro      PROGBITS         00000000000a9630  000a8630</div><div class="line">       0000000000002430  0000000000000000  WA       0     0     16</div><div class="line">  [12] .init_array       INIT_ARRAY       00000000000aba60  000aaa60</div><div class="line">       0000000000000038  0000000000000000  WA       0     0     8</div><div class="line">  [13] .dynamic          DYNAMIC          00000000000aba98  000aaa98</div><div class="line">       0000000000000150  0000000000000010  WA       3     0     8</div><div class="line">  [14] .got              PROGBITS         00000000000abbe8  000aabe8</div><div class="line">       0000000000000400  0000000000000000  WA       0     0     8</div><div class="line">  [15] .got.plt          PROGBITS         00000000000abfe8  000aafe8</div><div class="line">       0000000000000018  0000000000000000  WA       0     0     8</div><div class="line">  [16] .data             PROGBITS         00000000000ac000  000ab000</div><div class="line">       0000000000000ce0  0000000000000000  WA       0     0     32</div><div class="line">  [17] .bss              NOBITS           00000000000ad000  000abce0</div><div class="line">       00000000000065c4  0000000000000000  WA       0     0     4096</div><div class="line">  [18] .comment          PROGBITS         0000000000000000  000abce0</div><div class="line">       0000000000000063  0000000000000001  MS       0     0     1</div><div class="line">  [19] .note.gnu.gold-ve NOTE             0000000000000000  000abd44</div><div class="line">       000000000000001c  0000000000000000           0     0     4</div><div class="line">  [20] .gnu_debuglink    PROGBITS         0000000000000000  000abd60</div><div class="line">       0000000000000010  0000000000000000           0     0     1</div><div class="line">  [21] .shstrtab         STRTAB           0000000000000000  000abd70</div><div class="line">       00000000000000f4  0000000000000000           0     0     1</div><div class="line">  [22] .symtab           SYMTAB           0000000000000000  000abe68</div><div class="line">       0000000000019ad0  0000000000000018          23   4377     8</div><div class="line">  [23] .strtab           STRTAB           0000000000000000  000c5938</div><div class="line">       000000000001c27b  0000000000000000           0     0     1</div><div class="line">Key to Flags:</div><div class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</div><div class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</div><div class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</div></pre></td></tr></table></figure></p>
<p>####特殊节<br><img src="~/18-29-04.jpg" alt=""></p>
<p><font color="#FF0000">.bss</font><br>构成程序的内存映像的未初始化数据。根据定义，系统在程序开始运行时会将数据初始化为零。如节类型 SHT_NOBITS 所指明的那样，此节不会占用任何文件空间。<br>.comment<br>注释信息，通常由编译系统的组件提供。此节可以由 mcs(1) 进行处理。</p>
<p><font color="#FF0000">.data、.data1</font><br>构成程序的内存映像的已初始化数据。</p>
<p><font color="#FF0000">.dynamic</font><br>动态链接信息。有关详细信息，请参见动态节。<br>.dynstr<br>进行动态链接所需的字符串，通常是表示与符号表各项关联的名称的字符串。<br>.dynsym<br>动态链接符号表。有关详细信息，请参见符号表节。<br>.eh_frame_hdr、.eh_frame<br>用于展开栈的调用帧信息。<br>.fini<br>可执行指令，用于构成包含此节的可执行文件或共享目标文件的单个终止函数。有关详细信息，请参见初始化和终止例程。<br>.fini_array<br>函数指针数组，用于构成包含此节的可执行文件或共享目标文件的单个终止数组。有关详细信息，请参见初始化和终止例程。<br>.got<br>全局偏移表。有关详细信息，请参见全局偏移表（特定于处理器）。<br>.hash<br>符号散列表。有关详细信息，请参见散列表节。<br>.init<br>可执行指令，用于构成包含此节的可执行文件或共享目标文件的单个初始化函数。有关详细信息，请参见初始化和终止例程。<br>.init_array<br>函数指针数组，用于构成包含此节的可执行文件或共享目标文件的单个初始化数组。有关详细信息，请参见初始化和终止例程。<br>.interp<br>程序的解释程序的路径名。有关详细信息，请参见程序的解释程序。<br>.lbss<br>特定于 x64 的未初始化的数据。此数据与 .bss 类似，但用于大小超过 2 GB 的节。<br>.ldata、.ldata1<br>特定于 x64 的已初始化数据。此数据与 .data 类似，但用于大小超过 2 GB 的节。<br>.lrodata、.lrodata1<br>特定于 x64 的只读数据。此数据与 .rodata 类似，但用于大小超过 2 GB 的节。<br>.note<br>注释节中说明了该格式的信息。<br>.plt<br>过程链接表。有关详细信息，请参见过程链接表（特定于处理器）。<br>.preinit_array<br>函数指针数组，用于构成包含此节的可执行文件或共享目标文件的单个预初始化数组。有关详细信息，请参见初始化和终止例程。<br>.rela<br>不适用于特定节的重定位。此节的用途之一是用于寄存器重定位。有关详细信息，请参见寄存器符号。<br>.relname、.relaname<br>重定位信息，如重定位节中所述。如果文件具有包括重定位的可装入段，则此节的属性将包括 SHF_ALLOC 位。否则，该位会处于禁用状态。通常，name 由应用重定位的节提供。因此，.text 的重定位节的名称通常为 .rel.text 或 .rela.text。<br>.rodata、.rodata1<br>通常构成进程映像中的非可写段的只读数据。有关详细信息，请参见程序头。<br>.shstrtab<br>节名称。<br>.strtab<br>字符串，通常是表示与符号表各项关联的名称的字符串。如果文件具有包括符号字符串表的可装入段，则此节的属性将包括 SHF_ALLOC 位。否则，该位会处于禁用状态。<br>.symtab<br>符号表，如符号表节中所述。如果文件具有包括符号表的可装入段，则此节的属性将包括 SHF_ALLOC 位。否则，该位会处于禁用状态。<br>.symtab_shndx<br>此节包含特殊符号表的节索引数组，如 .symtab 所述。如果关联的符号表节包括 SHF_ALLOC 位，则此节的属性也将包括该位。否则，该位会处于禁用状态。<br>.tbss<br>此节包含构成程序的内存映像的未初始化线程局部数据。根据定义，为每个新执行流实例化数据时，系统都会将数据初始化为零。如节类型 SHT_NOBITS 所指明的那样，此节不会占用任何文件空间。有关详细信息，请参见第 8 章。<br>.tdata、.tdata1<br>这些节包含已初始化的线程局部数据，这些数据构成程序的内存映像。对于每个新执行流，系统会对其内容的副本进行实例化。有关详细信息，请参见第 8 章。<br>.text<br>程序的文本或可执行指令。<br>.SUNW_bss<br>共享目标文件的部分初始化数据，这些数据构成程序的内存映像。数据会在运行时进行初始化。如节类型 SHT_NOBITS 所指明的那样，此节不会占用任何文件空间。<br>.SUNW_cap<br>功能要求。有关详细信息，请参见功能节。<br>.SUNW_capchain<br>功能链表。有关详细信息，请参见功能节。<br>.SUNW_capinfo<br>功能符号信息。有关详细信息，请参见功能节。<br>.SUNW_heap<br>从 dldump(3C) 中创建的动态可执行文件的堆。<br>.SUNW_dynsymsort<br>.SUNW_ldynsym – .dynsym 组合符号表中符号的索引数组。该索引进行排序，以按照地址递增的顺序引用符号。不表示变量或函数的符号不包括在内。对于冗余全局符号和弱符号，仅保留弱符号。有关详细信息，请参见符号排序节。<br>.SUNW_dyntlssort<br>.SUNW_ldynsym – .dynsym 组合符号表中线程局部存储符号的索引数组。该索引进行排序，以按照偏移递增的顺序引用符号。不表示 TLS 变量的符号不包括在内。对于冗余全局符号和弱符号，仅保留弱符号。有关详细信息，请参见符号排序节。<br>.SUNW_ldynsym<br>扩充 .dynsym 节。此节包含局部函数符号，以在完整的 .symtab 节不可用时在上下文中使用。链接编辑器始终将 .SUNW_ldynsym 节的数据放置在紧邻 .dynsym 节之前。这两个节始终使用相同的 .dynstr 字符串表节。这种放置和组织方式使两个符号表可以被视为一个更大的符号表。请参见符号表节。<br>.SUNW_move<br>部分初始化数据的附加信息。有关详细信息，请参见移动节。<br>.SUNW_reloc<br>重定位信息，如重定位节中所述。此节是多个重定位节的串联，用于为引用各个重定位记录提供更好的临近性。由于仅有重定位记录的偏移有意义，因此节的 sh_info 值为零。<br>.SUNW_syminfo<br>其他符号表信息。有关详细信息，请参见Syminfo 表节。<br>.SUNW_version<br>版本控制信息。有关详细信息，请参见版本控制节。<br>具有点 (.) 前缀的节名为系统而保留，但如果这些节的现有含义符合要求，则应用程序也可以使用这些节。应用程序可以使用不带前缀的名称，以避免与系统节产生冲突。使用目标文件格式，可以定义非保留的节。一个目标文件可以包含多个同名的节。<br>保留用于处理器体系结构的节名称通过在节名称前加上体系结构名称的缩写而构成。该名称应来自用于 e_machine 的体系结构名称。例如，.Foo.psect 是根据 FOO 体系结构定义的 psect 节。<br>现有扩展使用其历史名称。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="andy" />
          <p class="site-author-name" itemprop="name">andy</p>
          <p class="site-description motion-element" itemprop="description">Android开发</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">andy</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
